<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Re:note</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #fff; }
        .header { background: linear-gradient(#ff9933, #ffcc99); padding: 15px; display: flex; justify-content: space-between; align-items: center; color: white; }
        .container { padding: 20px; text-align: center; }
        .hidden { display: none; }
        input { display: block; width: 80%; margin: 10px auto; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        .main-btn { padding: 10px 20px; background: #6699cc; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .del-btn { background: #ff4444; padding: 5px 10px; font-size: 12px; }
        
        /* ãƒªã‚¹ãƒˆã®è¦‹ãŸç›® */
        .item-row { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 10px; margin-bottom: 5px; border-radius: 5px; border: 1px solid #ddd; }
        
        /* ã‚«ãƒ¼ãƒ‰ã®è¦‹ãŸç›® */
        .card-box { border: 2px solid #ff9933; border-radius: 10px; height: 150px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin: 20px 0; background: #fffcf5; cursor: pointer; position: relative; }
        .trash-link { color: #999; text-decoration: underline; font-size: 12px; cursor: pointer; display: block; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="header">
        <div style="font-weight:bold; font-size:20px;">My Re:note</div>
        <div onclick="location.reload()" style="cursor:pointer;">ğŸ </div>
    </div>

    <div id="auth-screen" class="container">
        <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button class="main-btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <p style="font-size:12px; color:blue;" onclick="register()">ã¯ã˜ã‚ã¦ã®æ–¹ï¼ˆæ–°è¦ç™»éŒ²ï¼‰</p>
    </div>

    <div id="home-screen" class="container hidden">
        <h3>ã‚ˆã†ã“ãã€<span id="u-name"></span>ã•ã‚“</h3>
        <button class="main-btn" style="width:200px; height:60px;" onclick="showScreen('deck')">æš—è¨˜ã‚«ãƒ¼ãƒ‰</button>
    </div>

    <div id="deck-screen" class="container hidden">
        <h2>æš—è¨˜ã‚«ãƒ¼ãƒ‰</h2>
        <input type="text" id="new-deck" placeholder="æ–°ã—ã„ã‚¸ãƒ£ãƒ³ãƒ«ï¼ˆä¾‹ï¼šè‹±å˜èªï¼‰">
        <button class="main-btn" onclick="addDeck()">ã‚¸ãƒ£ãƒ³ãƒ«ä½œæˆ</button>
        <div id="deck-list"></div>
        <span class="trash-link" onclick="showScreen('trash')">ğŸ—‘ ã‚´ãƒŸç®±ã‚’è¦‹ã‚‹</span>
    </div>

    <div id="card-screen" class="container hidden">
        <h2 id="current-deck-name">å­¦ç¿’</h2>
        <div class="card-box" id="flashcard" onclick="flip()">
            <div id="card-text">ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹</div>
        </div>
        <p style="font-size:12px;">ã‚¿ãƒƒãƒ—ã§ã‚ãã‚‹ / ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆæœªå®Ÿè£…ï¼‰</p>
        <hr>
        <h4>ã‚«ãƒ¼ãƒ‰è¿½åŠ </h4>
        <input type="text" id="word" placeholder="è¡¨ï¼ˆèªå¥ï¼‰">
        <input type="text" id="mean" placeholder="è£ï¼ˆæ„å‘³ï¼‰">
        <button class="main-btn" onclick="addCard()">è¿½åŠ </button>
        <div id="card-list" style="text-align:left; margin-top:20px;"></div>
    </div>

    <div id="trash-screen" class="container hidden">
        <h2>ã‚´ãƒŸç®±ï¼ˆ30æ—¥å¾Œã«æ¶ˆå»ï¼‰</h2>
        <div id="trash-list"></div>
        <button class="main-btn" style="background:#999;" onclick="showScreen('deck')">æˆ»ã‚‹</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAqOQcttYS7zpy2aMbRWVlDYVUQb5S28XM",
            authDomain: "re-note-f83a1.firebaseapp.com",
            projectId: "re-note-f83a1",
            storageBucket: "re-note-f83a1.firebasestorage.app",
            messagingSenderId: "296038093171",
            appId: "1:296038093171:web:e5a31640dbbd23d9397506"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let curDeckId = "";
        let isFlipped = false;
        let currentCardData = { word: "", mean: "" };

        function showScreen(id) {
            ['auth','home','deck','card','trash'].forEach(s => document.getElementById(s+'-screen').classList.add('hidden'));
            document.getElementById(id+'-screen').classList.remove('hidden');
            if(id === 'deck') loadDecks();
            if(id === 'trash') loadTrash();
        }

        async function login() {
            try {
                const user = await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value);
                const doc = await db.collection("users").doc(user.user.uid).get();
                document.getElementById('u-name').innerText = doc.data().username;
                showScreen('home');
            } catch (e) { alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—"); }
        }

        async function register() {
            const email = prompt("ç™»éŒ²ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹");
            const pass = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰");
            const name = prompt("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ");
            if(!email || !pass || !name) return;
            try {
                const res = await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection("users").doc(res.user.uid).set({ username: name, email: email });
                alert("ç™»éŒ²å®Œäº†ï¼å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
            } catch (e) { alert(e.message); }
        }

        // --- ã‚¸ãƒ£ãƒ³ãƒ«ç®¡ç† ---
        async function addDeck() {
            const name = document.getElementById('new-deck').value;
            if(!name) return;
            await db.collection("users").doc(auth.currentUser.uid).collection("decks").add({ name: name, deleted: false });
            document.getElementById('new-deck').value = "";
            loadDecks();
        }

        async function loadDecks() {
            const list = document.getElementById('deck-list');
            list.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
            const snap = await db.collection("users").doc(auth.currentUser.uid).collection("decks").where("deleted", "==", false).get();
            list.innerHTML = "";
            snap.forEach(doc => {
                const div = document.createElement('div');
                div.className = "item-row";
                div.innerHTML = `<span onclick="openDeck('${doc.id}', '${doc.data().name}')" style="cursor:pointer; flex:1;">ğŸ“‚ ${doc.data().name}</span>
                                 <button class="main-btn del-btn" onclick="trashDeck('${doc.id}')">å‰Šé™¤</button>`;
                list.appendChild(div);
            });
        }

        async function trashDeck(id) {
            if(!confirm("ã‚´ãƒŸç®±ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ")) return;
            await db.collection("users").doc(auth.currentUser.uid).collection("decks").doc(id).update({ deleted: true, deletedAt: new Date() });
            loadDecks();
        }

        // --- ã‚´ãƒŸç®± ---
        async function loadTrash() {
            const list = document.getElementById('trash-list');
            list.innerHTML = "";
            const snap = await db.collection("users").doc(auth.currentUser.uid).collection("decks").where("deleted", "==", true).get();
            snap.forEach(doc => {
                const div = document.createElement('div');
                div.className = "item-row";
                div.innerHTML = `<span>${doc.data().name}</span>
                                 <button class="main-btn" style="background:green; padding:5px;" onclick="restoreDeck('${doc.id}')">å¾©å…ƒ</button>`;
                list.appendChild(div);
            });
        }

        async function restoreDeck(id) {
            await db.collection("users").doc(auth.currentUser.uid).collection("decks").doc(id).update({ deleted: false });
            loadTrash();
        }

        // --- ã‚«ãƒ¼ãƒ‰ç®¡ç† ---
        function openDeck(id, name) {
            curDeckId = id;
            document.getElementById('current-deck-name').innerText = name;
            showScreen('card');
            loadCards();
        }

        async function addCard() {
            const word = document.getElementById('word').value;
            const mean = document.getElementById('mean').value;
            if(!word || !mean) return;
            await db.collection("users").doc(auth.currentUser.uid).collection("decks").doc(curDeckId).collection("cards").add({ word, mean });
            document.getElementById('word').value = "";
            document.getElementById('mean').value = "";
            loadCards();
        }

        async function loadCards() {
            const list = document.getElementById('card-list');
            list.innerHTML = "";
            const snap = await db.collection("users").doc(auth.currentUser.uid).collection("decks").doc(curDeckId).collection("cards").get();
            snap.forEach(doc => {
                const div = document.createElement('div');
                div.className = "item-row";
                div.innerHTML = `<span>${doc.data().word} : ${doc.data().mean}</span>
                                 <button class="main-btn del-btn" onclick="deleteCard('${doc.id}')">æ¶ˆå»</button>`;
                list.appendChild(div);
                currentCardData = doc.data(); // è¡¨ç¤ºç”¨
            });
            document.getElementById('card-text').innerText = snap.empty ? "ã‚«ãƒ¼ãƒ‰ãªã—" : currentCardData.word;
        }

        async function deleteCard(id) {
            await db.collection("users").doc(auth.currentUser.uid).collection("decks").doc(curDeckId).collection("cards").doc(id).delete();
            loadCards();
        }

        function flip() {
            isFlipped = !isFlipped;
            document.getElementById('card-text').innerText = isFlipped ? currentCardData.mean : currentCardData.word;
            document.getElementById('flashcard').style.background = isFlipped ? "#fff0f0" : "#fffcf5";
        }
    </script>
</body>
</html>
