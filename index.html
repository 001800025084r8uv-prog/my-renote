<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Re:note</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #fff; color: #333; }
        .header { background: linear-gradient(#ff9933, #ffcc99); padding: 15px; display: flex; justify-content: space-between; align-items: center; color: white; font-weight: bold; }
        .container { padding: 20px; text-align: center; }
        .hidden { display: none; }
        input { display: block; width: 85%; margin: 10px auto; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; }
        .main-btn { padding: 12px 24px; background: #6699cc; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 5px; font-size: 16px; width: 80%; }
        .del-btn { background: #ff4444; width: auto; padding: 5px 10px; font-size: 12px; }
        .item-row { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #ddd; }
        .card-box { border: 3px solid #ff9933; border-radius: 15px; height: 180px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin: 20px 0; background: #fffcf5; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; }
        .trash-link { color: #888; text-decoration: underline; font-size: 14px; margin-top: 30px; display: block; }
        .loading { color: #ff9933; font-weight: bold; margin-top: 50px; }
    </style>
</head>
<body>

    <div class="header">
        <div>My Re:note</div>
        <div onclick="location.reload()" style="cursor:pointer; font-size:24px;">ğŸ </div>
    </div>

    <div id="loading-screen" class="container">
        <p class="loading">ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ä¸­...</p>
    </div>

    <div id="auth-screen" class="container hidden">
        <h2>ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h2>
        <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button class="main-btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="main-btn" style="background:#66cc99;" onclick="register()">æ–°è¦ç™»éŒ²</button>
        <p style="font-size:12px; color:#666; margin-top:10px;">â€»æ–°è¦ç™»éŒ²æ™‚ã¯åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input type="text" id="reg-name" placeholder="ï¼ˆæ–°è¦ç”¨ï¼‰ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
    </div>

    <div id="home-screen" class="container hidden">
        <h3>ã‚ˆã†ã“ãã€<span id="u-name"></span>ã•ã‚“</h3>
        <button class="main-btn" style="height:80px; font-size:20px; background:#ff9933;" onclick="showScreen('deck')">ğŸ“– æš—è¨˜ã‚«ãƒ¼ãƒ‰</button>
        <br><br>
        <button class="main-btn" style="background:#999;" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div id="deck-screen" class="container hidden">
        <h2>æš—è¨˜ã‚«ãƒ¼ãƒ‰</h2>
        <input type="text" id="new-deck" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«åï¼ˆä¾‹ï¼šæ­´å²ï¼‰">
        <button class="main-btn" onclick="addDeck()">ã‚¸ãƒ£ãƒ³ãƒ«ä½œæˆ</button>
        <div id="deck-list"></div>
        <span class="trash-link" onclick="showScreen('trash')">ğŸ—‘ ã‚´ãƒŸç®±ï¼ˆå¾©å…ƒï¼‰</span>
        <button class="main-btn" style="background:#999; margin-top:20px;" onclick="showScreen('home')">æˆ»ã‚‹</button>
    </div>

    <div id="card-screen" class="container hidden">
        <h2 id="current-deck-name">å­¦ç¿’</h2>
        <div class="card-box" onclick="flip()">
            <div id="card-text">ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—</div>
        </div>
        <input type="text" id="word" placeholder="è¡¨ï¼ˆèªå¥ï¼‰">
        <input type="text" id="mean" placeholder="è£ï¼ˆæ„å‘³ï¼‰">
        <button class="main-btn" onclick="addCard()">ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ </button>
        <div id="card-list" style="text-align:left; margin-top:20px;"></div>
        <button class="main-btn" style="background:#999;" onclick="showScreen('deck')">ã‚¸ãƒ£ãƒ³ãƒ«ä¸€è¦§ã¸</button>
    </div>

    <div id="trash-screen" class="container hidden">
        <h2>ã‚´ãƒŸç®±</h2>
        <p style="font-size:12px;">30æ—¥ä»¥å†…ã«å¾©å…ƒå¯èƒ½ã§ã™</p>
        <div id="trash-list"></div>
        <button class="main-btn" onclick="showScreen('deck')">æˆ»ã‚‹</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAqOQcttYS7zpy2aMbRWVlDYVUQb5S28XM",
            authDomain: "re-note-f83a1.firebaseapp.com",
            projectId: "re-note-f83a1",
            storageBucket: "re-note-f83a1.firebasestorage.app",
            messagingSenderId: "296038093171",
            appId: "1:296038093171:web:e5a31640dbbd23d9397506"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let curDeckId = "";
        let isFlipped = false;
        let currentCards = [];
        let cardIdx = 0;

        // â˜… ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’è‡ªå‹•ç›£è¦–ã™ã‚‹ã€Œå¿ƒè‡“éƒ¨ã€
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const doc = await db.collection("users").doc(user.uid).get();
                if (doc.exists) {
                    document.getElementById('u-name').innerText = doc.data().username;
                    showScreen('home');
                }
            } else {
                showScreen('auth');
            }
        });

        function showScreen(id) {
            ['loading','auth','home','deck','card','trash'].forEach(s => document.getElementById(s+'-screen').classList.add('hidden'));
            document.getElementById(id+'-screen').classList.remove('hidden');
            if(id === 'deck') loadDecks();
            if(id === 'trash') loadTrash();
        }

        async function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            try { await auth.signInWithEmailAndPassword(email, pass); } catch (e) { alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç­‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }
        }

        async function register() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            const name = document.getElementById('reg-name').value;
            if(!name) return alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            try {
                const res = await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection("users").doc(res.user.uid).set({ username: name, email: email });
                alert("ç™»éŒ²æˆåŠŸï¼");
            } catch (e) { alert("ç™»éŒ²å¤±æ•—: " + e.message); }
        }

        function logout() { auth.signOut(); }

        // --- ã‚¸ãƒ£ãƒ³ãƒ« ---
        async function addDeck() {
            const name = document.getElementById('new-deck').value;
            if(!name) return;
            await db.collection("users").doc(auth.currentUser.uid).collection("decks").add({ name: name, deleted: false, createdAt: new Date() });
            document.getElementById('new-deck').value = "";
            loadDecks();
        }

        async function loadDecks() {
            const list = document.getElementById('deck-list');
            list.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
            const snap = await db.collection("users").doc(auth.currentUser.uid).collection("decks").where("deleted", "==", false).get();
            list.innerHTML = "";
            snap.forEach(doc => {
                const div = document.createElement('div');
