<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Re:note</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #fff; color: #333; overflow-x: hidden; }
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒ³å¾©æ´» */
        .header { background: linear-gradient(to bottom, #ff9933, #ffcc99); padding: 15px; display: flex; justify-content: space-between; align-items: center; color: white; border-bottom-left-radius: 50% 20px; border-bottom-right-radius: 50% 20px; }
        .logo { font-size: 24px; font-weight: bold; }
        .menu-btn { width: 35px; cursor: pointer; filter: brightness(0) invert(1); }
        
        /* ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .side-menu { position: fixed; top: 0; right: -250px; width: 200px; height: 100%; background: rgba(0, 0, 0, 0.85); color: white; padding: 20px; transition: 0.3s; z-index: 1000; }
        .side-menu.open { right: 0; }
        .side-menu ul { list-style: none; padding: 0; margin-top: 50px; }
        .side-menu li { padding: 15px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.2); cursor: pointer; }

        .container { padding: 20px; text-align: center; }
        .hidden { display: none; }
        input { display: block; width: 85%; margin: 10px auto; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; }
        .main-btn { padding: 12px 24px; background: #6699cc; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 5px; font-size: 16px; width: 85%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* æš—è¨˜ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .item-row { display: flex; justify-content: space-between; align-items: center; background: #fdfdfd; padding: 15px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card-box { border: 3px solid #ff9933; border-radius: 15px; height: 180px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin: 20px auto; background: #fffcf5; width: 90%; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .trash-link { color: #888; text-decoration: underline; font-size: 14px; margin-top: 30px; display: block; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">My Re:note</div>
        <img src="https://cdn-icons-png.flaticon.com/512/588/588395.png" class="menu-btn" onclick="toggleMenu()" alt="Menu">
    </div>

    <div id="side-menu" class="side-menu">
        <div onclick="toggleMenu()" style="text-align:right; cursor:pointer; font-size:24px;">Ã—</div>
        <ul>
            <li onclick="showScreen('home')">ğŸ  ãƒ›ãƒ¼ãƒ </li>
            <li onclick="showScreen('deck')">ğŸ“– æš—è¨˜ã‚«ãƒ¼ãƒ‰</li>
            <li onclick="logout()" style="color:#ff8888;">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</li>
        </ul>
    </div>

    <div id="loading-screen" class="container">
        <p style="margin-top:100px; color:#ff9933; font-weight:bold;">ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ä¸­...</p>
    </div>

    <div id="auth-screen" class="container hidden">
        <h2>ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h2>
        <input type="email" id="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
        <input type="password" id="pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button class="main-btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
        <input type="text" id="reg-name" placeholder="ï¼ˆæ–°è¦ç”¨ï¼‰ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
        <button class="main-btn" style="background:#66cc99;" onclick="register()">æ–°ã—ãã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œã‚‹</button>
    </div>

    <div id="home-screen" class="container hidden">
        <h3 style="text-align:left;">ã‚ˆã†ã“ãã€<span id="u-name"></span>ã•ã‚“</h3>
        <div style="background:#f0f0f0; padding:20px; border-radius:15px; margin-bottom:20px;">
            <p style="font-size:14px; color:#666;">ä»Šæ—¥ã®å­¦ç¿’äºˆå®š</p>
            <p>ã¾ã äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>
        </div>
        <button class="main-btn" style="height:100px; font-size:20px; background:#ff9933;" onclick="showScreen('deck')">æš—è¨˜ã‚«ãƒ¼ãƒ‰ã‚’ã¯ã˜ã‚ã‚‹</button>
    </div>

    <div id="deck-screen" class="container hidden">
        <h2>ğŸ“– æš—è¨˜ã‚«ãƒ¼ãƒ‰</h2>
        <input type="text" id="new-deck" placeholder="ã‚¸ãƒ£ãƒ³ãƒ«åï¼ˆä¾‹ï¼šæ—¥æœ¬å²ï¼‰">
        <button class="main-btn" onclick="addDeck()">ï¼‹ ã‚¸ãƒ£ãƒ³ãƒ«ã‚’ä½œæˆ</button>
        <div id="deck-list" style="margin-top:20px;"></div>
        <span class="trash-link" onclick="showScreen('trash')">ğŸ—‘ ã‚´ãƒŸç®±ï¼ˆå¾©å…ƒï¼‰</span>
    </div>

    <div id="card-screen" class="container hidden">
        <h2 id="current-deck-name">å­¦ç¿’</h2>
        <div class="card-box" onclick="flip()">
            <div id="card-text">ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹</div>
        </div>
        <div style="background:#f9f9f9; padding:15px; border-radius:10px;">
            <h4>ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ </h4>
            <input type="text" id="word" placeholder="è¡¨ï¼ˆèªå¥ï¼‰">
            <input type="text" id="mean" placeholder="è£ï¼ˆæ„å‘³ï¼‰">
            <button class="main-btn" onclick="addCard()">è¿½åŠ </button>
        </div>
        <div id="card-list" style="margin-top:20px; text-align:left;"></div>
        <button class="main-btn" style="background:#999;" onclick="showScreen('deck')">ä¸€è¦§ã«æˆ»ã‚‹</button>
    </div>

    <div id="trash-screen" class="container hidden">
        <h2>ã‚´ãƒŸç®±</h2>
        <div id="trash-list"></div>
        <button class="main-btn" onclick="showScreen('deck')">æˆ»ã‚‹</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAqOQcttYS7zpy2aMbRWVlDYVUQb5S28XM",
            authDomain: "re-note-f83a1.firebaseapp.com",
            projectId: "re-note-f83a1",
            storageBucket: "re-note-f83a1.firebasestorage.app",
            messagingSenderId: "296038093171",
            appId: "1:296038093171:web:e5a31640dbbd23d9397506"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let curDeckId = "";
        let isFlipped = false;
        let currentCards = [];
        let cardIdx = 0;

        // å®‰å…¨è£…ç½®
        const safety = setTimeout(() => { if(!document.getElementById('loading-screen').classList.contains('hidden')) showScreen('auth'); }, 5000);

        auth.onAuthStateChanged(async (user) => {
            clearTimeout(safety);
            if (user) {
                const doc = await db.collection("users").doc(user.uid).get();
                if (doc.exists) {
                    document.getElementById('u-name').innerText = doc.data().username;
                    showScreen('home');
                } else { showScreen('auth'); }
            } else { showScreen('auth'); }
        });

        function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); }

        function showScreen(id) {
            ['loading','auth','home','deck','card','trash'].forEach(s => document.getElementById(s+'-screen').classList.add('hidden'));
            document.getElementById(id+'-screen').classList.remove('hidden');
            if(id === 'deck') loadDecks();
            if(id === 'trash') loadTrash();
            const menu = document.getElementById('side-menu');
            if(menu.classList.contains('open')) menu.classList.remove('open');
        }

        async function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            try { await auth.signInWithEmailAndPassword(email, pass); } 
            catch (e) { alert("ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + e.message); }
        }

        async function register() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            const name = document.getElementById('reg-name').value;
            if(!name) return alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            try {
                const res = await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection("users").doc(res.user.uid).set({ username: name, email: email });
                alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
            } catch (e) { alert("ç™»éŒ²å¤±æ•—: " + e.message); }
        }

        function logout() { auth.signOut().then(() => location.reload()); }

        // ã‚«ãƒ†ã‚´ãƒªãƒ¼
        async function addDeck() {
            const name = document.getElementById('new-deck').value;
            if(!name) return;
            await db.collection("users").doc(auth.currentUser.uid).collection("decks").add({ name: name, deleted: false, createdAt: new Date() });
            document.getElementById('new-deck').value = "";
            loadDecks();
        }

        async function loadDecks() {
            const list = document.getElementById('deck-list');
            list.innerHTML = "èª­è¾¼ä¸­...";
            const snap = await db.collection("users").doc(auth.currentUser.uid).collection("decks").where("deleted", "==", false).orderBy("createdAt", "desc").get();
            list.innerHTML = "";
            snap.forEach(doc => {
                const div = document.createElement('div');
                div.className = "item-row";
                div.innerHTML = `<span onclick="openDeck('${doc.id}', '${doc.data().name}')" style="flex:1; text-align:left; font-weight:bold;">ğŸ“‚ ${doc.data().name}</span>
                                 <button onclick="trashDeck('${doc.id}')" style="background:#ff4444; color:white; border:none; border-radius:5px; padding:5px 10px;">å‰Šé™¤</button>`;
                list.appendChild(div);
            });
        }

        async function trashDeck(id) {
            await db.collection("users").doc(auth.currentUser.uid).collection("decks").doc(id).update({ deleted: true, deletedAt: new Date() });
            loadDecks();
        }

        async function loadTrash() {
            const list = document.getElementById('trash-list');
            list.innerHTML = "";
            const snap = await db.collection("users").doc(auth.currentUser.uid).collection("decks").where("deleted", "==", true).get();
            snap.forEach(doc => {
                const div = document.createElement('div');
                div.className = "item-row";
                div.innerHTML = `<span>${doc.data().name}</span><button onclick="restoreDeck('${doc.id}')" style="background:green; color:white; border:none; border-radius:5px; padding:5px 10px;">å¾©å…ƒ</button>`;
                list.appendChild(div);
            });
        }

        async function restoreDeck(id) {
            await db.collection("users").doc(auth.currentUser.uid).collection("decks").doc(id).update({ deleted: false });
            loadTrash();
        }

        // ã‚«ãƒ¼ãƒ‰
        function openDeck(id, name) {
            curDeckId = id;
            document.getElementById('current-deck-name').innerText = name;
            showScreen('card');
            loadCards();
        }

        async function addCard() {
            const word = document.getElementById('word').value;
            const mean = document.getElementById('mean').value;
            if(!word || !mean) return;
            await db.collection("users").doc(auth.currentUser.uid).collection("decks").doc(curDeckId).collection("cards").add({ word, mean, createdAt: new Date() });
            document.getElementById('word').value = "";
            document.getElementById('mean').value = "";
            loadCards();
        }

        async function loadCards() {
            const list = document.getElementById('card-list');
            list.innerHTML = "";
            const snap = await db.collection("users").doc(auth.currentUser.uid).collection("decks").doc(curDeckId).collection("cards").orderBy("createdAt", "asc").get();
            currentCards = [];
            snap.forEach(doc => {
                currentCards.push(doc.data());
                const div = document.createElement('div');
                div.className = "item-row";
                div.innerHTML = `<span style="font-size:14px;">${doc.data().word} / ${doc.data().mean}</span>
                                 <button onclick="deleteCard('${doc.id}')" style="background:#ff4444; color:white; border:none; border-radius:5px; padding:5px 10px;">æ¶ˆå»</button>`;
                list.appendChild(div);
            });
            cardIdx = 0;
            updateCardDisplay();
        }

        async function deleteCard(id) {
            await db.collection("users").doc(auth.currentUser.uid).collection("decks").doc(curDeckId).collection("cards").doc(id).delete();
            loadCards();
        }

        function updateCardDisplay() {
            isFlipped = false;
            const display = document.getElementById('card-text');
            if(currentCards.length > 0) { display.innerText = currentCards[cardIdx].word; } 
            else { display.innerText = "ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ã­"; }
        }

        function flip() {
            if(currentCards.length === 0) return;
            isFlipped = !isFlipped;
            document.getElementById('card-text').innerText = isFlipped ? currentCards[cardIdx].mean : currentCards[cardIdx].word;
        }
    </script>
</body>
</html>
